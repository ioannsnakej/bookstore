@Library('jenkins-shared-lib') _

def remote = [:]

pipeline {
  agent { label 'target' }
  
  parameters {
    string (name: 'DOCKER_IMAGE', description: 'Image to deploy', defaultValue: 'ivankhodyrev/bookstore:latest')
  }

  environment {
    HOST = "192.168.56.3"
    TOKEN = credentials('docker_creds')
    PRJ_DIR = "/var/www/bookstore"
    GIT_URL = "git@github.com:ioannsnakej/bookstore.git"
    TG_BOT_TOKEN=credentials('bot_token')
    TG_CHAT_ID=credentials('chat_id')
    DB_USER = credentials('db_user')
    DB_NAME = credentials('db_name')
    DB_HOST = credentials('db_host')
    DB_PASS = credentials('db_pass')
    TAG = "latest"
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: "main", url: "${GIT_URL}", credentialsId: 'github_ssh'
      }
    }

    stage('Add .env and compose.yml') {
      steps {
        script {
          sh '''
            cp -r * ${PRJ_DIR}/
            cd ${PRJ_DIR}
            rm -f .env
            cat > .env << EOF
            DB_USER=${DB_USER}
            DB_NAME=${DB_NAME}
            DB_HOST=${DB_HOST}
            DB_PASS=${DB_PASS}
            EOF

            export DOCKER_IMAGE=${params.DOCKER_IMAGE}
            envsubst < compose.tmpl > compose.yml
          '''
        }
      }
    }

    stage('Prepare Credentials') {
      steps {
        withCredentials([sshUserPrivateKey(credentialsId: 'jenkins_ssh', usernameVariable: 'username', keyFileVariable: 'private_key')]) {
          script {
            remote.name = env.HOST
            remote.host = env.HOST
            remote.user = "${username}"
            remote.identity = readFile "${private_key}"
            remote.allowAnyHosts = true
          }
        }
      }
    }

    stage('Deploy') {
      steps {
        script {
          sshCommand remote: remote, command: """
            set -x
            docker pull "${params.DOCKER_IMAGE}"
            cd "${env.PRJ_DIR}"
            docker compose up -d
          """
        }
      }
    }
  }

  post {
    success {
      script {
        notifyTelegram("✅ Deploy success", env.TG_BOT_TOKEN, env.TG_CHAT_ID)
      }
    }
    failure {
      script {
        notifyTelegram("❌ Deploy failed", env.TG_BOT_TOKEN, env.TG_CHAT_ID)
      }
    }
  }
}
